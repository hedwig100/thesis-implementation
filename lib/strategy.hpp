#ifndef _STRATEGY_HPP
#define _STRATEGY_HPP

#include <cassert>
#include <vector>

namespace montgomery {

// This function should not be used directly.
std::vector<int> _generate_strategy(const int e) {
    if (e == 2) return {};
    if (e % 4 == 0) {
        auto half_strategy        = _generate_strategy(e / 2);
        std::vector<int> strategy = {e / 4};
        for (int a : half_strategy)
            strategy.push_back(a);
        for (int a : half_strategy)
            strategy.push_back(a);
        return strategy;
    }
    if (e % 4 == 2) {
        auto half_strategy0       = _generate_strategy(e / 2 - 1),
             half_strategy1       = _generate_strategy(e / 2 + 1);
        std::vector<int> strategy = {(e + 2) / 4};
        for (int a : half_strategy0)
            strategy.push_back(a);
        for (int a : half_strategy1)
            strategy.push_back(a);
        return strategy;
    }
    assert(0 && "e must be even.");
}

// Optimized strategy for Doliskani's algorithm.
std::vector<int> optimized_strategy(const int e) {
    // p:256bits
    if (e == 240)
        return {104, 58, 32, 20, 10, 6,  4,  2,  2,  2, 2, 2, 4, 2,  2,  2, 10,
                4,   2,  2,  2,  4,  2,  2,  2,  14, 8, 4, 2, 2, 2,  4,  2, 2,
                6,   4,  2,  2,  2,  2,  26, 14, 8,  4, 2, 2, 2, 4,  2,  2, 6,
                4,   2,  2,  2,  2,  10, 6,  4,  2,  2, 2, 2, 2, 4,  2,  2, 2,
                44,  26, 16, 8,  4,  2,  2,  2,  4,  2, 2, 6, 4, 2,  2,  2, 2,
                2,   10, 6,  4,  2,  2,  2,  2,  2,  4, 2, 2, 2, 18, 10, 6, 4,
                2,   2,  2,  2,  2,  4,  2,  2,  2,  8, 4, 2, 2, 2,  4,  2, 2};
    else if (e == 241)
        return {109, 56, 32, 18, 10, 6, 4,  2,  2,  2,  2,  2, 4,  2, 2,
                2,   8,  4,  2,  2,  2, 4,  2,  2,  14, 8,  4, 2,  2, 2,
                4,   2,  2,  6,  4,  2, 2,  2,  2,  24, 14, 8, 4,  2, 2,
                2,   4,  2,  2,  6,  4, 2,  2,  2,  2,  10, 6, 4,  2, 2,
                2,   2,  4,  2,  2,  2, 43, 26, 16, 10, 6,  4, 2,  2, 2,
                2,   4,  2,  2,  2,  6, 4,  2,  2,  2,  2,  2, 10, 6, 4,
                2,   2,  2,  2,  2,  4, 2,  2,  2,  17, 10, 6, 4,  2, 2,
                2,   2,  2,  4,  2,  2, 2,  7,  4,  2,  2,  2, 3,  2, 1};
    else if (e == 242)
        return {106, 58, 32, 20, 10, 6, 4, 2, 2,  2,  2,  2,  4,  2, 2,
                2,   10, 4,  2,  2,  2, 4, 2, 2,  2,  14, 8,  4,  2, 2,
                2,   4,  2,  2,  6,  4, 2, 2, 2,  2,  26, 14, 8,  4, 2,
                2,   2,  4,  2,  2,  6, 4, 2, 2,  2,  2,  10, 6,  4, 2,
                2,   2,  2,  2,  4,  2, 2, 2, 44, 26, 16, 10, 4,  2, 2,
                2,   4,  2,  2,  2,  6, 4, 2, 2,  2,  2,  2,  10, 6, 4,
                2,   2,  2,  2,  2,  4, 2, 2, 2,  18, 10, 6,  4,  2, 2,
                2,   2,  2,  4,  2,  2, 2, 8, 4,  2,  2,  2,  4,  2, 2};
    // p:512bits
    else if (e == 500)
        return {216, 122, 66, 40, 24, 14, 8,  4,  2, 2, 2,  4,  2,  2, 6,  4,
                2,   2,   2,  2,  10, 6,  4,  2,  2, 2, 2,  4,  2,  2, 2,  16,
                10,  6,   4,  2,  2,  2,  2,  4,  2, 2, 2,  6,  4,  2, 2,  2,
                2,   2,   26, 16, 10, 6,  4,  2,  2, 2, 2,  4,  2,  2, 2,  6,
                4,   2,   2,  2,  2,  2,  10, 6,  4, 2, 2,  2,  2,  2, 4,  2,
                2,   2,   56, 26, 16, 10, 6,  4,  2, 2, 2,  2,  4,  2, 2,  2,
                6,   4,   2,  2,  2,  2,  2,  10, 6, 4, 2,  2,  2,  2, 2,  4,
                2,   2,   2,  24, 14, 8,  4,  2,  2, 2, 4,  2,  2,  6, 4,  2,
                2,   2,   2,  10, 6,  4,  2,  2,  2, 2, 4,  2,  2,  2, 96, 54,
                26,  16,  10, 6,  4,  2,  2,  2,  2, 4, 2,  2,  2,  6, 4,  2,
                2,   2,   2,  2,  10, 6,  4,  2,  2, 2, 2,  2,  4,  2, 2,  2,
                24,  14,  6,  4,  2,  2,  2,  2,  2, 6, 4,  2,  2,  2, 2,  10,
                6,   4,   2,  2,  2,  2,  4,  2,  2, 2, 40, 24, 14, 8, 4,  2,
                2,   2,   4,  2,  2,  6,  4,  2,  2, 2, 2,  10, 6,  4, 2,  2,
                2,   2,   4,  2,  2,  2,  16, 10, 6, 4, 2,  2,  2,  2, 4,  2,
                2,   2,   6,  4,  2,  2,  2,  2,  2};
    else if (e == 501)
        return {223, 116, 66, 40, 24, 14, 8,  4,  2, 2, 2, 4,  2,  2,  6,  4,
                2,   2,   2,  2,  10, 6,  4,  2,  2, 2, 2, 4,  2,  2,  2,  16,
                10,  6,   4,  2,  2,  2,  2,  4,  2, 2, 2, 6,  4,  2,  2,  2,
                2,   2,   26, 16, 10, 6,  4,  2,  2, 2, 2, 4,  2,  2,  2,  6,
                4,   2,   2,  2,  2,  2,  10, 6,  4, 2, 2, 2,  2,  2,  4,  2,
                2,   2,   50, 26, 16, 10, 6,  4,  2, 2, 2, 2,  4,  2,  2,  2,
                6,   4,   2,  2,  2,  2,  2,  10, 6, 4, 2, 2,  2,  2,  2,  4,
                2,   2,   2,  24, 10, 6,  4,  2,  2, 2, 2, 2,  4,  2,  2,  2,
                10,  6,   4,  2,  2,  2,  2,  4,  2, 2, 2, 93, 56, 32, 18, 10,
                6,   4,   2,  2,  2,  2,  4,  2,  2, 2, 8, 4,  2,  2,  2,  4,
                2,   2,   14, 8,  4,  2,  2,  2,  4, 2, 2, 6,  4,  2,  2,  2,
                2,   24,  14, 8,  4,  2,  2,  2,  4, 2, 2, 6,  4,  2,  2,  2,
                2,   10,  6,  4,  2,  2,  2,  2,  4, 2, 2, 2,  41, 24, 12, 6,
                4,   2,   2,  2,  2,  2,  6,  2,  2, 2, 2, 10, 6,  4,  2,  2,
                2,   2,   4,  2,  2,  2,  17, 10, 6, 4, 2, 2,  2,  2,  4,  2,
                2,   2,   7,  4,  2,  2,  2,  3,  2, 1};
    else if (e == 502)
        return {214, 120, 72, 40, 24, 14, 8,  4,  2,  2, 2,  4, 2,  2,  6,  4,
                2,   2,   2,  2,  10, 6,  4,  2,  2,  2, 2,  4, 2,  2,  2,  16,
                10,  6,   4,  2,  2,  2,  2,  4,  2,  2, 2,  6, 4,  2,  2,  2,
                2,   2,   32, 16, 10, 6,  4,  2,  2,  2, 2,  4, 2,  2,  2,  6,
                4,   2,   2,  2,  2,  2,  14, 8,  4,  2, 2,  2, 4,  2,  2,  6,
                4,   2,   2,  2,  2,  54, 26, 16, 10, 6, 4,  2, 2,  2,  2,  4,
                2,   2,   2,  6,  4,  2,  2,  2,  2,  2, 10, 6, 4,  2,  2,  2,
                2,   2,   4,  2,  2,  2,  24, 14, 6,  4, 2,  2, 2,  2,  2,  6,
                4,   2,   2,  2,  2,  10, 6,  4,  2,  2, 2,  2, 4,  2,  2,  2,
                94,  54,  26, 16, 10, 6,  4,  2,  2,  2, 2,  4, 2,  2,  2,  6,
                4,   2,   2,  2,  2,  2,  10, 6,  4,  2, 2,  2, 2,  2,  4,  2,
                2,   2,   24, 14, 6,  4,  2,  2,  2,  2, 2,  6, 4,  2,  2,  2,
                2,   10,  6,  4,  2,  2,  2,  2,  4,  2, 2,  2, 40, 24, 14, 6,
                4,   2,   2,  2,  2,  2,  6,  4,  2,  2, 2,  2, 10, 6,  4,  2,
                2,   2,   2,  4,  2,  2,  2,  16, 10, 6, 4,  2, 2,  2,  2,  4,
                2,   2,   2,  6,  4,  2,  2,  2,  2,  2};
    // p:1024bits
    else if (e == 1010)
        return {
            448, 242, 132, 78, 44, 26, 16, 10, 6,  4,   2,   2,  2,  2,  4,  2,
            2,   2,   6,   4,  2,  2,  2,  2,  2,  10,  6,   4,  2,  2,  2,  2,
            2,   4,   2,   2,  2,  18, 10, 6,  4,  2,   2,   2,  2,  2,  4,  2,
            2,   2,   8,   4,  2,  2,  2,  4,  2,  2,   32,  20, 10, 6,  4,  2,
            2,   2,   2,   2,  4,  2,  2,  2,  8,  6,   2,   2,  2,  2,  4,  2,
            2,   14,  8,   4,  2,  2,  2,  4,  2,  2,   6,   4,  2,  2,  2,  2,
            56,  32,  18,  10, 6,  4,  2,  2,  2,  2,   2,   4,  2,  2,  2,  8,
            4,   2,   2,   2,  4,  2,  2,  14, 8,  4,   2,   2,  2,  4,  2,  2,
            6,   4,   2,   2,  2,  2,  24, 14, 8,  4,   2,   2,  2,  4,  2,  2,
            6,   4,   2,   2,  2,  2,  10, 6,  4,  2,   2,   2,  2,  4,  2,  2,
            2,   106, 58,  32, 20, 10, 6,  4,  2,  2,   2,   2,  2,  4,  2,  2,
            2,   8,   6,   2,  2,  2,  2,  4,  2,  2,   14,  8,  4,  2,  2,  2,
            4,   2,   2,   6,  4,  2,  2,  2,  2,  26,  14,  8,  4,  2,  2,  2,
            4,   2,   2,   6,  4,  2,  2,  2,  2,  10,  6,   4,  2,  2,  2,  2,
            2,   4,   2,   2,  2,  44, 24, 16, 10, 6,   2,   2,  2,  2,  4,  2,
            2,   2,   6,   4,  2,  2,  2,  2,  2,  10,  6,   4,  2,  2,  2,  2,
            4,   2,   2,   2,  18, 10, 6,  4,  2,  2,   2,   2,  2,  4,  2,  2,
            2,   8,   4,   2,  2,  2,  4,  2,  2,  182, 108, 64, 40, 24, 14, 6,
            4,   2,   2,   2,  2,  2,  6,  4,  2,  2,   2,   2,  10, 6,  4,  2,
            2,   2,   2,   4,  2,  2,  2,  16, 10, 6,   4,   2,  2,  2,  2,  4,
            2,   2,   2,   6,  4,  2,  2,  2,  2,  2,   24,  16, 10, 6,  4,  2,
            2,   2,   2,   4,  2,  2,  2,  6,  4,  2,   2,   2,  2,  2,  10, 6,
            4,   2,   2,   2,  2,  4,  2,  2,  2,  44,  24,  16, 10, 6,  4,  2,
            2,   2,   2,   4,  2,  2,  2,  6,  4,  2,   2,   2,  2,  2,  10, 6,
            4,   2,   2,   2,  2,  4,  2,  2,  2,  18,  10,  6,  4,  2,  2,  2,
            2,   2,   4,   2,  2,  2,  8,  4,  2,  2,   2,   4,  2,  2,  76, 44,
            24,  16,  10,  6,  2,  2,  2,  2,  4,  2,   2,   2,  6,  4,  2,  2,
            2,   2,   2,   10, 6,  4,  2,  2,  2,  2,   4,   2,  2,  2,  18, 10,
            6,   4,   2,   2,  2,  2,  2,  4,  2,  2,   2,   8,  4,  2,  2,  2,
            4,   2,   2,   32, 18, 10, 6,  4,  2,  2,   2,   2,  2,  4,  2,  2,
            2,   8,   4,   2,  2,  2,  4,  2,  2,  14,  8,   4,  2,  2,  2,  4,
            2,   2,   6,   4,  2,  2,  2,  2};
    else if (e == 1011)
        return {409, 254, 142, 96, 44, 26, 16, 10, 6,  4,  2,   2,  2,  2,  4,
                2,   2,   2,   6,  4,  2,  2,  2,  2,  2,  10,  6,  4,  2,  2,
                2,   2,   2,   4,  2,  2,  2,  18, 10, 6,  4,   2,  2,  2,  2,
                2,   4,   2,   2,  2,  8,  4,  2,  2,  2,  4,   2,  2,  40, 24,
                14,  8,   4,   2,  2,  2,  4,  2,  2,  6,  4,   2,  2,  2,  2,
                10,  6,   4,   2,  2,  2,  2,  4,  2,  2,  2,   16, 10, 6,  4,
                2,   2,   2,   2,  4,  2,  2,  2,  6,  4,  2,   2,  2,  2,  2,
                64,  32,  20,  10, 6,  4,  2,  2,  2,  2,  2,   4,  2,  2,  2,
                8,   6,   2,   2,  2,  2,  4,  2,  2,  14, 8,   4,  2,  2,  2,
                4,   2,   2,   6,  4,  2,  2,  2,  2,  24, 16,  10, 6,  4,  2,
                2,   2,   2,   4,  2,  2,  2,  6,  4,  2,  2,   2,  2,  2,  10,
                6,   4,   2,   2,  2,  2,  4,  2,  2,  2,  108, 64, 34, 22, 10,
                6,   4,   2,   2,  2,  2,  2,  4,  2,  2,  2,   10, 6,  2,  2,
                2,   2,   4,   2,  2,  2,  16, 8,  4,  2,  2,   2,  4,  2,  2,
                6,   4,   2,   2,  2,  2,  2,  24, 16, 10, 6,   4,  2,  2,  2,
                2,   4,   2,   2,  2,  6,  4,  2,  2,  2,  2,   2,  10, 6,  4,
                2,   2,   2,   2,  4,  2,  2,  2,  44, 24, 16,  10, 6,  4,  2,
                2,   2,   2,   4,  2,  2,  2,  6,  4,  2,  2,   2,  2,  2,  10,
                6,   4,   2,   2,  2,  2,  4,  2,  2,  2,  18,  10, 6,  4,  2,
                2,   2,   2,   2,  4,  2,  2,  2,  8,  4,  2,   2,  2,  4,  2,
                2,   175, 100, 56, 32, 20, 10, 6,  4,  2,  2,   2,  2,  2,  4,
                2,   2,   2,   8,  6,  2,  2,  2,  2,  4,  2,   2,  14, 8,  4,
                2,   2,   2,   4,  2,  2,  6,  4,  2,  2,  2,   2,  24, 14, 8,
                4,   2,   2,   2,  4,  2,  2,  6,  4,  2,  2,   2,  2,  10, 6,
                4,   2,   2,   2,  2,  4,  2,  2,  2,  44, 24,  14, 8,  4,  2,
                2,   2,   4,   2,  2,  6,  4,  2,  2,  2,  2,   10, 6,  4,  2,
                2,   2,   2,   4,  2,  2,  2,  18, 10, 6,  4,   2,  2,  2,  2,
                2,   4,   2,   2,  2,  8,  4,  2,  2,  2,  4,   2,  2,  77, 42,
                24,  14,  8,   4,  2,  2,  2,  4,  2,  2,  6,   4,  2,  2,  2,
                2,   10,  6,   4,  2,  2,  2,  2,  4,  2,  2,   2,  18, 10, 6,
                4,   2,   2,   2,  2,  4,  2,  2,  2,  8,  4,   2,  2,  2,  4,
                2,   2,   33,  18, 10, 6,  4,  2,  2,  2,  2,   2,  4,  2,  2,
                2,   8,   4,   2,  2,  2,  4,  2,  2,  15, 8,   4,  2,  2,  2,
                4,   2,   2,   7,  4,  2,  2,  3,  2,  1};
    else if (e == 1012)
        return {
            428, 264, 132, 78, 44,  26,  16, 10, 6,  4,  2,  2,  2,  2,  4,  2,
            2,   2,   6,   4,  2,   2,   2,  2,  2,  10, 6,  4,  2,  2,  2,  2,
            2,   4,   2,   2,  2,   18,  10, 6,  4,  2,  2,  2,  2,  2,  4,  2,
            2,   2,   8,   4,  2,   2,   2,  4,  2,  2,  32, 20, 10, 6,  4,  2,
            2,   2,   2,   2,  4,   2,   2,  2,  8,  6,  2,  2,  2,  2,  4,  2,
            2,   14,  8,   4,  2,   2,   2,  4,  2,  2,  6,  4,  2,  2,  2,  2,
            56,  32,  18,  10, 6,   4,   2,  2,  2,  2,  2,  4,  2,  2,  2,  8,
            4,   2,   2,   2,  4,   2,   2,  14, 8,  4,  2,  2,  2,  4,  2,  2,
            6,   4,   2,   2,  2,   2,   24, 14, 8,  4,  2,  2,  2,  4,  2,  2,
            6,   4,   2,   2,  2,   2,   10, 6,  4,  2,  2,  2,  2,  4,  2,  2,
            2,   110, 60,  40, 24,  14,  6,  4,  2,  2,  2,  2,  2,  6,  4,  2,
            2,   2,   2,   10, 6,   4,   2,  2,  2,  2,  4,  2,  2,  2,  16, 10,
            6,   4,   2,   2,  2,   2,   4,  2,  2,  2,  6,  4,  2,  2,  2,  2,
            2,   24,  16,  8,  6,   2,   2,  2,  2,  4,  2,  2,  6,  4,  2,  2,
            2,   2,   2,   10, 6,   4,   2,  2,  2,  2,  4,  2,  2,  2,  44, 26,
            16,  10,  6,   4,  2,   2,   2,  2,  4,  2,  2,  2,  6,  4,  2,  2,
            2,   2,   2,   10, 6,   4,   2,  2,  2,  2,  2,  4,  2,  2,  2,  18,
            10,  6,   4,   2,  2,   2,   2,  2,  4,  2,  2,  2,  8,  4,  2,  2,
            2,   4,   2,   2,  186, 106, 58, 32, 20, 10, 6,  4,  2,  2,  2,  2,
            2,   4,   2,   2,  2,   8,   6,  2,  2,  2,  2,  4,  2,  2,  14, 8,
            4,   2,   2,   2,  4,   2,   2,  6,  4,  2,  2,  2,  2,  26, 14, 8,
            4,   2,   2,   2,  4,   2,   2,  6,  4,  2,  2,  2,  2,  10, 6,  4,
            2,   2,   2,   2,  2,   4,   2,  2,  2,  44, 24, 16, 10, 6,  2,  2,
            2,   2,   4,   2,  2,   2,   6,  4,  2,  2,  2,  2,  2,  10, 6,  4,
            2,   2,   2,   2,  4,   2,   2,  2,  18, 10, 6,  4,  2,  2,  2,  2,
            2,   4,   2,   2,  2,   8,   4,  2,  2,  2,  4,  2,  2,  76, 44, 26,
            16,  10,  6,   4,  2,   2,   2,  2,  4,  2,  2,  2,  6,  4,  2,  2,
            2,   2,   2,   10, 6,   4,   2,  2,  2,  2,  2,  4,  2,  2,  2,  18,
            10,  6,   4,   2,  2,   2,   2,  2,  4,  2,  2,  2,  8,  4,  2,  2,
            2,   4,   2,   2,  32,  18,  10, 6,  4,  2,  2,  2,  2,  2,  4,  2,
            2,   2,   8,   4,  2,   2,   2,  4,  2,  2,  14, 8,  4,  2,  2,  2,
            4,   2,   2,   6,  4,   2,   2,  2,  2};
    else if (e == 1520)
        return {
            658, 372, 214, 114, 66, 40, 24,  14, 8,  4,   2,  2,   2,   4,  2,
            2,   6,   4,   2,   2,  2,  2,   10, 6,  4,   2,  2,   2,   2,  4,
            2,   2,   2,   16,  10, 6,  4,   2,  2,  2,   2,  4,   2,   2,  2,
            6,   4,   2,   2,   2,  2,  2,   26, 16, 10,  6,  4,   2,   2,  2,
            2,   4,   2,   2,   2,  6,  4,   2,  2,  2,   2,  2,   10,  6,  4,
            2,   2,   2,   2,   2,  4,  2,   2,  2,  48,  26, 16,  10,  6,  4,
            2,   2,   2,   2,   4,  2,  2,   2,  6,  4,   2,  2,   2,   2,  2,
            10,  6,   4,   2,   2,  2,  2,   2,  4,  2,   2,  2,   18,  12, 8,
            4,   2,   2,   2,   4,  2,  2,   6,  2,  2,   2,  2,   8,   4,  2,
            2,   2,   4,   2,   2,  94, 54,  26, 16, 10,  6,  4,   2,   2,  2,
            2,   4,   2,   2,   2,  6,  4,   2,  2,  2,   2,  2,   10,  6,  4,
            2,   2,   2,   2,   2,  4,  2,   2,  2,  24,  12, 8,   4,   2,  2,
            2,   4,   2,   2,   6,  2,  2,   2,  2,  10,  6,  4,   2,   2,  2,
            2,   4,   2,   2,   2,  40, 24,  12, 8,  4,   2,  2,   2,   4,  2,
            2,   6,   2,   2,   2,  2,  10,  6,  4,  2,   2,  2,   2,   4,  2,
            2,   2,   16,  10,  6,  4,  2,   2,  2,  2,   4,  2,   2,   2,  6,
            4,   2,   2,   2,   2,  2,  154, 90, 56, 32,  16, 10,  6,   4,  2,
            2,   2,   2,   4,   2,  2,  2,   6,  4,  2,   2,  2,   2,   2,  14,
            8,   4,   2,   2,   2,  4,  2,   2,  6,  4,   2,  2,   2,   2,  24,
            14,  8,   4,   2,   2,  2,  4,   2,  2,  6,   4,  2,   2,   2,  2,
            10,  6,   4,   2,   2,  2,  2,   4,  2,  2,   2,  40,  22,  12, 6,
            4,   2,   2,   2,   2,  2,  6,   2,  2,  2,   2,  8,   6,   4,  2,
            2,   2,   2,   4,   2,  2,  16,  10, 6,  4,   2,  2,   2,   2,  4,
            2,   2,   2,   6,   4,  2,  2,   2,  2,  2,   66, 40,  18,  12, 8,
            4,   2,   2,   2,   4,  2,  2,   6,  2,  2,   2,  2,   8,   4,  2,
            2,   2,   4,   2,   2,  16, 10,  6,  4,  2,   2,  2,   2,   4,  2,
            2,   2,   6,   4,   2,  2,  2,   2,  2,  26,  16, 10,  6,   4,  2,
            2,   2,   2,   4,   2,  2,  2,   6,  4,  2,   2,  2,   2,   2,  10,
            6,   4,   2,   2,   2,  2,  2,   4,  2,  2,   2,  272, 162, 96, 56,
            32,  16,  10,  6,   4,  2,  2,   2,  2,  4,   2,  2,   2,   6,  4,
            2,   2,   2,   2,   2,  14, 8,   4,  2,  2,   2,  4,   2,   2,  6,
            4,   2,   2,   2,   2,  24, 14,  8,  4,  2,   2,  2,   4,   2,  2,
            6,   4,   2,   2,   2,  2,  10,  6,  4,  2,   2,  2,   2,   4,  2,
            2,   2,   40,  24,  14, 8,  4,   2,  2,  2,   4,  2,   2,   6,  4,
            2,   2,   2,   2,   10, 6,  4,   2,  2,  2,   2,  4,   2,   2,  2,
            16,  10,  6,   4,   2,  2,  2,   2,  4,  2,   2,  2,   6,   4,  2,
            2,   2,   2,   2,   66, 40, 24,  14, 8,  4,   2,  2,   2,   4,  2,
            2,   6,   4,   2,   2,  2,  2,   10, 6,  4,   2,  2,   2,   2,  4,
            2,   2,   2,   16,  10, 6,  4,   2,  2,  2,   2,  4,   2,   2,  2,
            6,   4,   2,   2,   2,  2,  2,   26, 16, 10,  6,  4,   2,   2,  2,
            2,   4,   2,   2,   2,  6,  4,   2,  2,  2,   2,  2,   10,  6,  4,
            2,   2,   2,   2,   2,  4,  2,   2,  2,  110, 66, 40,  24,  14, 8,
            4,   2,   2,   2,   4,  2,  2,   6,  4,  2,   2,  2,   2,   10, 6,
            4,   2,   2,   2,   2,  4,  2,   2,  2,  16,  10, 6,   4,   2,  2,
            2,   2,   4,   2,   2,  2,  6,   4,  2,  2,   2,  2,   2,   26, 16,
            10,  6,   4,   2,   2,  2,  2,   4,  2,  2,   2,  6,   4,   2,  2,
            2,   2,   2,   10,  6,  4,  2,   2,  2,  2,   2,  4,   2,   2,  2,
            44,  26,  16,  10,  6,  4,  2,   2,  2,  2,   4,  2,   2,   2,  6,
            4,   2,   2,   2,   2,  2,  10,  6,  4,  2,   2,  2,   2,   2,  4,
            2,   2,   2,   18,  10, 6,  4,   2,  2,  2,   2,  2,   4,   2,  2,
            2,   8,   4,   2,   2,  2,  4,   2,  2};
    else if (e == 1521)
        return {
            649, 372, 214, 122, 68, 40, 24, 14, 8,  4,  2,   2,   2,  4,  2,
            2,   6,   4,   2,   2,  2,  2,  10, 6,  4,  2,   2,   2,  2,  4,
            2,   2,   2,   16,  10, 6,  4,  2,  2,  2,  2,   4,   2,  2,  2,
            6,   4,   2,   2,   2,  2,  2,  26, 18, 10, 6,   4,   2,  2,  2,
            2,   4,   2,   2,   2,  8,  4,  2,  2,  2,  4,   2,   2,  10, 6,
            4,   2,   2,   2,   2,  2,  4,  2,  2,  2,  56,  26,  16, 10, 6,
            4,   2,   2,   2,   2,  4,  2,  2,  2,  6,  4,   2,   2,  2,  2,
            2,   10,  6,   4,   2,  2,  2,  2,  2,  4,  2,   2,   2,  24, 14,
            8,   4,   2,   2,   2,  4,  2,  2,  6,  4,  2,   2,   2,  2,  10,
            6,   4,   2,   2,   2,  2,  4,  2,  2,  2,  94,  54,  26, 16, 10,
            6,   4,   2,   2,   2,  2,  4,  2,  2,  2,  6,   4,   2,  2,  2,
            2,   2,   10,  6,   4,  2,  2,  2,  2,  2,  4,   2,   2,  2,  24,
            12,  8,   4,   2,   2,  2,  4,  2,  2,  6,  2,   2,   2,  2,  10,
            6,   4,   2,   2,   2,  2,  4,  2,  2,  2,  40,  24,  12, 8,  4,
            2,   2,   2,   4,   2,  2,  6,  2,  2,  2,  2,   10,  6,  4,  2,
            2,   2,   2,   4,   2,  2,  2,  16, 10, 6,  4,   2,   2,  2,  2,
            4,   2,   2,   2,   6,  4,  2,  2,  2,  2,  2,   154, 90, 56, 32,
            16,  10,  6,   4,   2,  2,  2,  2,  4,  2,  2,   2,   6,  4,  2,
            2,   2,   2,   2,   14, 8,  4,  2,  2,  2,  4,   2,   2,  6,  4,
            2,   2,   2,   2,   24, 14, 8,  4,  2,  2,  2,   4,   2,  2,  6,
            4,   2,   2,   2,   2,  10, 6,  4,  2,  2,  2,   2,   4,  2,  2,
            2,   40,  22,  12,  6,  4,  2,  2,  2,  2,  2,   6,   2,  2,  2,
            2,   8,   6,   4,   2,  2,  2,  2,  4,  2,  2,   16,  10, 6,  4,
            2,   2,   2,   2,   4,  2,  2,  2,  6,  4,  2,   2,   2,  2,  2,
            66,  40,  18,  12,  8,  4,  2,  2,  2,  4,  2,   2,   6,  2,  2,
            2,   2,   8,   4,   2,  2,  2,  4,  2,  2,  16,  10,  6,  4,  2,
            2,   2,   2,   4,   2,  2,  2,  6,  4,  2,  2,   2,   2,  2,  26,
            16,  10,  6,   4,   2,  2,  2,  2,  4,  2,  2,   2,   6,  4,  2,
            2,   2,   2,   2,   10, 6,  4,  2,  2,  2,  2,   2,   4,  2,  2,
            2,   271, 162, 96,  54, 26, 16, 10, 6,  4,  2,   2,   2,  2,  4,
            2,   2,   2,   6,   4,  2,  2,  2,  2,  2,  10,  6,   4,  2,  2,
            2,   2,   2,   4,   2,  2,  2,  24, 12, 8,  4,   2,   2,  2,  4,
            2,   2,   6,   2,   2,  2,  2,  10, 6,  4,  2,   2,   2,  2,  4,
            2,   2,   2,   40,  24, 14, 8,  4,  2,  2,  2,   4,   2,  2,  6,
            4,   2,   2,   2,   2,  10, 6,  4,  2,  2,  2,   2,   4,  2,  2,
            2,   16,  10,  6,   4,  2,  2,  2,  2,  4,  2,   2,   2,  6,  4,
            2,   2,   2,   2,   2,  66, 40, 24, 14, 8,  4,   2,   2,  2,  4,
            2,   2,   6,   4,   2,  2,  2,  2,  10, 6,  4,   2,   2,  2,  2,
            4,   2,   2,   2,   16, 10, 6,  4,  2,  2,  2,   2,   4,  2,  2,
            2,   6,   4,   2,   2,  2,  2,  2,  26, 16, 10,  6,   4,  2,  2,
            2,   2,   4,   2,   2,  2,  6,  4,  2,  2,  2,   2,   2,  10, 6,
            4,   2,   2,   2,   2,  2,  4,  2,  2,  2,  109, 66,  40, 24, 14,
            8,   4,   2,   2,   2,  4,  2,  2,  6,  4,  2,   2,   2,  2,  10,
            6,   4,   2,   2,   2,  2,  4,  2,  2,  2,  16,  10,  6,  4,  2,
            2,   2,   2,   4,   2,  2,  2,  6,  4,  2,  2,   2,   2,  2,  26,
            16,  10,  6,   4,   2,  2,  2,  2,  4,  2,  2,   2,   6,  4,  2,
            2,   2,   2,   2,   10, 6,  4,  2,  2,  2,  2,   2,   4,  2,  2,
            2,   43,  26,  16,  10, 6,  4,  2,  2,  2,  2,   4,   2,  2,  2,
            6,   4,   2,   2,   2,  2,  2,  10, 6,  4,  2,   2,   2,  2,  2,
            4,   2,   2,   2,   17, 10, 6,  4,  2,  2,  2,   2,   2,  4,  2,
            2,   2,   7,   4,   2,  2,  2,  3,  2,  1};
    else if (e == 1522)
        return {
            660, 372, 214, 114, 66, 40, 24,  14, 8,  4,  2,   2,   2,   4,  2,
            2,   6,   4,   2,   2,  2,  2,   10, 6,  4,  2,   2,   2,   2,  4,
            2,   2,   2,   16,  10, 6,  4,   2,  2,  2,  2,   4,   2,   2,  2,
            6,   4,   2,   2,   2,  2,  2,   26, 16, 10, 6,   4,   2,   2,  2,
            2,   4,   2,   2,   2,  6,  4,   2,  2,  2,  2,   2,   10,  6,  4,
            2,   2,   2,   2,   2,  4,  2,   2,  2,  48, 26,  16,  10,  6,  4,
            2,   2,   2,   2,   4,  2,  2,   2,  6,  4,  2,   2,   2,   2,  2,
            10,  6,   4,   2,   2,  2,  2,   2,  4,  2,  2,   2,   18,  12, 8,
            4,   2,   2,   2,   4,  2,  2,   6,  2,  2,  2,   2,   8,   4,  2,
            2,   2,   4,   2,   2,  94, 54,  26, 16, 10, 6,   4,   2,   2,  2,
            2,   4,   2,   2,   2,  6,  4,   2,  2,  2,  2,   2,   10,  6,  4,
            2,   2,   2,   2,   2,  4,  2,   2,  2,  24, 12,  8,   4,   2,  2,
            2,   4,   2,   2,   6,  2,  2,   2,  2,  10, 6,   4,   2,   2,  2,
            2,   4,   2,   2,   2,  40, 24,  12, 8,  4,  2,   2,   2,   4,  2,
            2,   6,   2,   2,   2,  2,  10,  6,  4,  2,  2,   2,   2,   4,  2,
            2,   2,   16,  10,  6,  4,  2,   2,  2,  2,  4,   2,   2,   2,  6,
            4,   2,   2,   2,   2,  2,  154, 90, 56, 32, 16,  10,  6,   4,  2,
            2,   2,   2,   4,   2,  2,  2,   6,  4,  2,  2,   2,   2,   2,  14,
            8,   4,   2,   2,   2,  4,  2,   2,  6,  4,  2,   2,   2,   2,  24,
            14,  8,   4,   2,   2,  2,  4,   2,  2,  6,  4,   2,   2,   2,  2,
            10,  6,   4,   2,   2,  2,  2,   4,  2,  2,  2,   40,  22,  12, 6,
            4,   2,   2,   2,   2,  2,  6,   2,  2,  2,  2,   8,   6,   4,  2,
            2,   2,   2,   4,   2,  2,  16,  10, 6,  4,  2,   2,   2,   2,  4,
            2,   2,   2,   6,   4,  2,  2,   2,  2,  2,  66,  40,  18,  12, 8,
            4,   2,   2,   2,   4,  2,  2,   6,  2,  2,  2,   2,   8,   4,  2,
            2,   2,   4,   2,   2,  16, 10,  6,  4,  2,  2,   2,   2,   4,  2,
            2,   2,   6,   4,   2,  2,  2,   2,  2,  26, 16,  10,  6,   4,  2,
            2,   2,   2,   4,   2,  2,  2,   6,  4,  2,  2,   2,   2,   2,  10,
            6,   4,   2,   2,   2,  2,  2,   4,  2,  2,  2,   272, 162, 96, 56,
            32,  18,  10,  6,   4,  2,  2,   2,  2,  4,  2,   2,   2,   8,  4,
            2,   2,   2,   4,   2,  2,  14,  8,  4,  2,  2,   2,   4,   2,  2,
            6,   4,   2,   2,   2,  2,  24,  14, 8,  4,  2,   2,   2,   4,  2,
            2,   6,   4,   2,   2,  2,  2,   10, 6,  4,  2,   2,   2,   2,  4,
            2,   2,   2,   40,  24, 14, 8,   4,  2,  2,  2,   4,   2,   2,  6,
            4,   2,   2,   2,   2,  10, 6,   4,  2,  2,  2,   2,   4,   2,  2,
            2,   16,  10,  6,   4,  2,  2,   2,  2,  4,  2,   2,   2,   6,  4,
            2,   2,   2,   2,   2,  66, 40,  24, 14, 8,  4,   2,   2,   2,  4,
            2,   2,   6,   4,   2,  2,  2,   2,  10, 6,  4,   2,   2,   2,  2,
            4,   2,   2,   2,   16, 10, 6,   4,  2,  2,  2,   2,   4,   2,  2,
            2,   6,   4,   2,   2,  2,  2,   2,  26, 16, 10,  6,   4,   2,  2,
            2,   2,   4,   2,   2,  2,  6,   4,  2,  2,  2,   2,   2,   10, 6,
            4,   2,   2,   2,   2,  2,  4,   2,  2,  2,  110, 66,  40,  24, 14,
            8,   4,   2,   2,   2,  4,  2,   2,  6,  4,  2,   2,   2,   2,  10,
            6,   4,   2,   2,   2,  2,  4,   2,  2,  2,  16,  10,  6,   4,  2,
            2,   2,   2,   4,   2,  2,  2,   6,  4,  2,  2,   2,   2,   2,  26,
            16,  10,  6,   4,   2,  2,  2,   2,  4,  2,  2,   2,   6,   4,  2,
            2,   2,   2,   2,   10, 6,  4,   2,  2,  2,  2,   2,   4,   2,  2,
            2,   44,  26,  16,  10, 6,  4,   2,  2,  2,  2,   4,   2,   2,  2,
            6,   4,   2,   2,   2,  2,  2,   10, 6,  4,  2,   2,   2,   2,  2,
            4,   2,   2,   2,   18, 10, 6,   4,  2,  2,  2,   2,   2,   4,  2,
            2,   2,   8,   4,   2,  2,  2,   4,  2,  2};
    assert(0 && "e must be 240, 241, 242, 500, 501, 502, 1010, 1011, 1012, "
                "1520, 1521, or 1522.");
}

// Generate strategy for Doliskani's algorithm.
std::vector<int> generate_strategy(const int e) {

    // When e is even.
    if (e % 2 == 0) {
        auto strategy_as_four_isog = _generate_strategy(e);
        for (auto &mul_e : strategy_as_four_isog)
            mul_e <<= 1;
        return strategy_as_four_isog;
    }

    // When e is odd.
    if (e == 1) return {};
    if (e == 3) return {1};

    if ((e - 1) % 4 == 0) {
        int f                     = (e - 1) / 2;
        auto half_strategy0       = generate_strategy(f),
             half_strategy1       = generate_strategy(f + 1);
        std::vector<int> strategy = {f + 1};
        for (int a : half_strategy0)
            strategy.push_back(a);
        for (int a : half_strategy1)
            strategy.push_back(a);
        return strategy;
    }

    // if ((e - 1) % 4 == 2)
    int f                     = (e - 1) / 2;
    auto half_strategy0       = generate_strategy(f - 1),
         half_strategy1       = generate_strategy(f + 2);
    std::vector<int> strategy = {f + 2};
    for (int a : half_strategy0)
        strategy.push_back(a);
    for (int a : half_strategy1)
        strategy.push_back(a);
    return strategy;
}

} // namespace montgomery

#endif